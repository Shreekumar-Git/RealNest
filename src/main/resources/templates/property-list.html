<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Property List - Real Estate Platform</title>

    <!-- âœ… Bootstrap 5.3 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- ðŸŒ¤ï¸ Modern Light Blue Theme -->
    <style>
      :root {
        --accent: #3b82f6; /* Primary blue */
        --accent-light: #60a5fa; /* Hover blue */
        --danger: #dc3545; /* Red for delete */
        --bg-main: #f5f7fa; /* Soft background */
        --card-bg: #ffffff; /* White cards */
        --text-dark: #1f2937; /* Neutral dark gray */
      }

      body {
        background: linear-gradient(180deg, #eaf1fb 0%, #f5f7fa 100%);
        font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        color: var(--text-dark);
        margin: 0;
        padding: 40px 20px;
      }

      .page-card {
        max-width: 1100px;
        margin: auto;
        background-color: var(--card-bg);
        border-radius: 14px;
        padding: 32px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      h1 {
        text-align: center;
        color: var(--accent);
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 24px;
      }

      /* Search Bar */
      .search-bar {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
        margin-bottom: 32px;
      }

      .search-bar input,
      .search-bar select {
        border: 1px solid #ced4da;
        border-radius: 10px;
        padding: 10px 14px;
        font-size: 0.95rem;
        background: #f9fafb;
        color: var(--text-dark);
        transition: all 0.2s ease;
      }

      .search-bar input:focus,
      .search-bar select:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        outline: none;
      }

      .search-bar button {
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s;
      }

      .btn-search {
        background-color: var(--accent);
        color: white;
        border: none;
      }

      .btn-search:hover {
        background-color: var(--accent-light);
        transform: translateY(-2px);
      }

      .btn-clear {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        color: var(--text-dark);
      }

      .btn-clear:hover {
        background-color: #e9ecef;
      }

      /* Grid Layout */
      .property-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 22px;
        padding-bottom: 30px;
      }

      .property-card {
        background-color: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: transform 0.25s, box-shadow 0.25s;
      }

      .property-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      }

      .property-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }

      .property-card h3 {
        margin: 10px 0 6px;
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--accent);
      }

      .property-card p {
        margin: 5px 0;
        font-size: 0.95rem;
        color: #374151;
      }

      .property-card .details {
        padding: 14px 16px;
      }

      .property-card a,
      .property-card button {
        display: inline-block;
        margin-top: 10px;
        margin-right: 8px;
        padding: 8px 12px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        cursor: pointer;
        border: none;
        color: #fff;
        transition: background-color 0.2s ease, transform 0.1s;
      }

      .property-card a {
        background-color: var(--accent);
      }

      .property-card a:hover {
        background-color: var(--accent-light);
        transform: translateY(-2px);
      }

      .property-card button {
        background-color: var(--danger);
      }

      .property-card button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }

      #list p {
        text-align: center;
        color: #6b7280;
        font-weight: 500;
        padding: 20px;
      }

      @media (max-width: 768px) {
        .property-grid {
          grid-template-columns: 1fr;
        }
        .search-bar input,
        .search-bar select {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <div class="page-card">
      <h1>Available Properties</h1>

      <!-- ðŸ” Search Bar -->
      <div class="search-bar">
        <input id="qKeyword" placeholder="Keyword (e.g. villa)" />
        <input id="qLocation" placeholder="Location" />
        <input id="qMinPrice" placeholder="Min Price" type="number" />
        <input id="qMaxPrice" placeholder="Max Price" type="number" />
        <select id="qType">
          <option value="">All Types</option>
          <option value="SALE">Sale</option>
          <option value="RENT">Rent</option>
        </select>
        <button id="btnSearch" class="btn-search">Search</button>
        <button id="btnClear" class="btn-clear">Clear</button>
      </div>

      <!-- ðŸ¡ Property Grid -->
      <div id="list" class="property-grid"></div>
    </div>

    <!-- âœ… Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      function parseJwt(token) {
        try {
          const base = token.split(".")[1];
          return JSON.parse(
            decodeURIComponent(
              atob(base)
                .split("")
                .map(
                  (c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)
                )
                .join("")
            )
          );
        } catch (e) {
          return null;
        }
      }

      const token = localStorage.getItem("token");
      const jwt = token ? parseJwt(token) : null;
      const currentEmail = jwt?.sub;
      const currentRole = jwt?.role || null;

      async function loadApproved() {
        try {
          const res = await fetch("/api/properties/approved");
          if (!res.ok) {
            document.getElementById("list").innerText =
              "Failed to load properties";
            return;
          }
          const props = await res.json();
          render(props);
        } catch (err) {
          console.error(err);
          document.getElementById("list").innerText =
            "Error loading properties";
        }
      }

      function render(props) {
        const container = document.getElementById("list");
        if (!props.length) {
          container.innerHTML = "<p>No properties found.</p>";
          return;
        }
        container.innerHTML = props
          .map(
            (p) => `
        <div class="property-card">
          <img src="${
            p.imageUrl || "https://via.placeholder.com/300x200?text=No+Image"
          }" alt="${p.title}">
          <div class="details">
            <h3>${p.title}</h3>
            <p>${p.description || ""}</p>
            <p><strong>Type:</strong> ${p.type} | <strong>Price:</strong> â‚¹${
              p.price
            }</p>
            <p><strong>Location:</strong> ${p.location}</p>
            <a href="/webpages/properties/${p.id}">View Details</a>
            ${showOwnerActions(p)}
          </div>
        </div>
      `
          )
          .join("");
      }

      function showOwnerActions(p) {
        if (!currentEmail) return "";
        const isOwner = p.owner && p.owner.email === currentEmail;
        const isAdmin = currentRole === "ROLE_ADMIN" || currentRole === "ADMIN";
        if (isOwner || isAdmin) {
          return `
          <button onclick="goEdit(${p.id})">Edit</button>
          <button onclick="doDelete(${p.id})">Delete</button>
        `;
        }
        return "";
      }

      function goEdit(id) {
        window.location.href = `/webpages/properties/edit/${id}`;
      }

      async function doDelete(id) {
        if (!confirm("Are you sure you want to delete this property?")) return;
        if (!currentEmail) return alert("Not authenticated");
        try {
          const res = await fetch(
            `/api/properties/delete/${id}?email=${encodeURIComponent(
              currentEmail
            )}`,
            {
              method: "DELETE",
              headers: { Authorization: "Bearer " + token },
            }
          );
          if (res.ok) {
            alert("Property deleted successfully!");
            loadApproved();
          } else {
            const text = await res.text();
            alert("Delete failed: " + text);
          }
        } catch (err) {
          console.error(err);
        }
      }

      document
        .getElementById("btnSearch")
        .addEventListener("click", async () => {
          const kw = document.getElementById("qKeyword").value;
          const loc = document.getElementById("qLocation").value;
          const min = document.getElementById("qMinPrice").value;
          const max = document.getElementById("qMaxPrice").value;
          const type = document.getElementById("qType").value;

          const params = new URLSearchParams();
          if (loc) params.append("location", loc);
          if (type) params.append("type", type);
          if (min) params.append("minPrice", min);
          if (max) params.append("maxPrice", max);
          if (kw) params.append("keyword", kw);

          const url = "/api/properties/search?" + params.toString();
          try {
            const res = await fetch(url);
            if (!res.ok) {
              document.getElementById("list").innerText = "Search failed";
              return;
            }
            const props = await res.json();
            render(props);
          } catch (err) {
            console.error(err);
          }
        });

      document.getElementById("btnClear").addEventListener("click", () => {
        document.getElementById("qKeyword").value = "";
        document.getElementById("qLocation").value = "";
        document.getElementById("qMinPrice").value = "";
        document.getElementById("qMaxPrice").value = "";
        document.getElementById("qType").value = "";
        loadApproved();
      });

      loadApproved();
    </script>
  </body>
</html>
